<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="referrer" content="no-referrer" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
      id="viewport"
    />
    <title>Douyin</title>
    <script>
      ;(function () {
        const host = window.location.hostname
        const isDev =
          host === 'localhost' ||
          host === '127.0.0.1' ||
          host.endsWith('.test') ||
          host.endsWith('.local')
        if (isDev) return

        const url = window.location.href
        const hasTgData =
          url.includes('tgWebAppData') ||
          window.location.hash.includes('tgWebAppData') ||
          window.location.search.includes('tgWebAppData')
        const uaTelegram = /Telegram/i.test(navigator.userAgent)
        const refTelegram = /t\.me|telegram\.org|telegram\.me|web\.telegram\.org/i.test(
          document.referrer || ''
        )
        const hasTelegramObj = !!(window.Telegram && window.Telegram.WebApp)

        if (!(hasTgData || uaTelegram || refTelegram || hasTelegramObj)) {
          document.documentElement.innerHTML = ''
          window.stop()
        }
      })()
    </script>
    <script>
      // 兜底 TelegramGameProxy，避免第三方脚本提前读取时报错
      window.TelegramGameProxy = window.TelegramGameProxy || {}
      if (typeof window.TelegramGameProxy.receiveEvent !== 'function') {
        window.TelegramGameProxy.receiveEvent = function () {}
      }
    </script>
    <!-- Telegram WebApp Script (Telegram 会自动注入，这里作为备用) -->
    <script>
      // ✅ 在 Telegram 环境中，同步加载 Telegram WebApp 脚本
      // 这样确保脚本在 Vue 应用初始化前就已经加载完成
      ;(function () {
        const url = window.location.href
        const hasTgData =
          url.includes('tgWebAppData') ||
          window.location.hash.includes('tgWebAppData') ||
          window.location.search.includes('tgWebAppData')
        const isTelegram =
          /Telegram/i.test(navigator.userAgent) || document.referrer.includes('telegram.org')

        if ((hasTgData || isTelegram) && !window.Telegram?.WebApp) {
          // ✅ 使用 document.write 同步加载脚本（确保在页面解析时立即加载）
          document.write(
            '<scr' + 'ipt src="https://telegram.org/js/telegram-web-app.js"><\/scr' + 'ipt>'
          )
        }
      })()
    </script>
    <script>
      // ✅ 尽早初始化 Telegram WebApp 并展开窗口
      ;(function () {
        // 等待 Telegram WebApp 加载完成
        const waitForTelegram = () => {
          return new Promise((resolve) => {
            if (window.Telegram?.WebApp) {
              resolve(window.Telegram.WebApp)
              return
            }

            // 轮询检查（最多等待 3 秒）
            let attempts = 0
            const maxAttempts = 30
            const checkInterval = setInterval(() => {
              attempts++
              if (window.Telegram?.WebApp) {
                clearInterval(checkInterval)
                resolve(window.Telegram.WebApp)
              } else if (attempts >= maxAttempts) {
                clearInterval(checkInterval)
                resolve(null)
              }
            }, 100)
          })
        }

        // 页面加载完成后立即初始化
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', async () => {
            const tg = await waitForTelegram()
            if (tg) {
              try {
                tg.ready()
                tg.expand()
                if (typeof tg.disableVerticalSwipes === 'function') {
                  tg.disableVerticalSwipes()
                }
                console.log('[Telegram] ✅ WebApp 初始化成功')
              } catch (e) {
                console.warn('[Telegram] 初始化失败:', e)
              }
            }
          })
        } else {
          waitForTelegram().then((tg) => {
            if (tg) {
              try {
                tg.ready()
                tg.expand()
                if (typeof tg.disableVerticalSwipes === 'function') {
                  tg.disableVerticalSwipes()
                }
                console.log('[Telegram] ✅ WebApp 初始化成功')
              } catch (e) {
                console.warn('[Telegram] 初始化失败:', e)
              }
            }
          })
        }
      })()
    </script>
    <!--    <script crossorigin="anonymous"-->
    <!--            integrity="sha512-KkkY/3auRhaXDFzFMpwtZ+BrS8EBQ+GfiBxdJ9jGMi6Gg74/sYbq/IZpY593pkNjTmbeRfBwjpZo+7gcpH45Ww=="-->
    <!--            src="https://lib.baomitu.com/eruda/3.0.1/eruda.min.js"></script>-->
    <!--      <script>eruda.init();</script>-->
    <!--    <script>-->
    <!--      var _hmt = _hmt || []-->
    <!--      ;(function () {-->
    <!--        var hm = document.createElement('script')-->
    <!--        hm.src = 'https://hm.baidu.com/hm.js?6f910830f5a7d8b5f7e75d8d67458a7a'-->
    <!--        var s = document.getElementsByTagName('script')[0]-->
    <!--        s.parentNode.insertBefore(hm, s)-->
    <!--      })()-->
    <!--    </script>-->
    <style>
      ::-webkit-scrollbar {
        display: none; /* Chrome Safari */
      }

      .fade-in {
        animation: fade-in 0.3s;
      }

      .fade-out {
        animation: fade-out 0.4s;
      }

      @keyframes fade-in {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fade-out {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
